= Using http://portal.mso4sc.eu[MSOPortal]
include::{partialsdir}/header-uri.adoc[]
include::{partialsdir}/header-levels.adoc[]

This document will provide basic information:

* to connect to the http://portal.mso4sc.eu[MSOPortal],
* to register an {hifimagnet} application,
* to purchase an {hifimagnet} application,
* to run an  {hifimagnet} application.

It will define the role of *DevUser* and *EndUser*.

[[connect]]
== Get an account on http://portal.mso4sc.eu[MSOPortal]

Connect to http://portal.mso4sc.eu[MSOPortal]

image::PortalMSO4SC_login.png[login page MSOPortal]

* Click on *login*

You will be forwarded to IDM component to the portal.

image::PortalMSO4SC_idm.png[IDM component of MSOPortal]

* Create an account there providing a valid email and a password.

Then you have to validate your account by following the instructions send
by the portal.

NOTE: Right now the portal *is not* using https protocol. As a consequence, the credentials `user/password` are
send in clear. So be careful. 

[[overview]]
== Overview of the Portal

image::PortalMSO4SC.png[Main page for MSOPortal]

the portal is split into several services:

* *Marketplace*, where you can add and/or purchase applications
* *Data Catalog*, where you can add and/or retrieve data
* *Experiments*, where the app is setup and the simulation is launched
* *Visualization*, to access a Remote desktop to pre and/or post-processes your simulations

more details on https://github.com/MSO4SC/MSOPortal/blob/master/portal/README.adoc[MSO4SC Front-end & Experiments Tool]

[[devuser]]
== *DevUser* role

=== Becoming *DevUser*

Once registered in the portal, you  are a *EndUser*.
To be granted *DevUser* rights, just email to Portal Admins (actually Victor or Javi).

[[registerapp]]
===  Register an {hifimagnet} application

To register an application you need to be *DevUSer*
The process is split into several part:

* add the app and create an offer in the *Marketplace*:
** go to *My stock/Catalog*
** go to *My stock/Product*
** go to *My stock/Offering*

Then you need to perform the following steps in *Experiments*:

* go to *RegisterApp*
** select the name of the *Offering*
** load the application.

[NOTE]
====
An application is an gzipped archive holding a directory which in tunrs contains :

* a `blueprint.yml` TOSCA file that describes the workflow
* a `scripts` subdirectory holding the scripts required to deploy and undeploy the app

In https://github.com/MSO4SC/resources/tree/master/blueprint/feelpp/hifimagnet_test(this git repository)
you will find the actual application corresponding to the {hifimagnet} basic demonstrator.

To actually build the app, use: ```./deploy pkg``` 
====

[[validorder]]
=== Validate an {hifimagnet} application purchase order

Once the app has been registered in the *Marketplace* (actually it means that an offering has been defined) you will be *owner* of this app. Any *EndUser* may purchase your app.
To check if you have any order:

* go to *My Inventory*
* go to *Product Orders*
* check *Recibibas* menu
* if any new message, you need to:
** click to validate the order
** click again to finalize the order

The *EndUser* may now proceed to perform *Experiments* with you product


[[enduser]]
== *EndUser* role

TIP: when running into some strange portal behavior, first try to `logout/login` from the portal
before reporting an issue.

TIP: make sure that you have access to https://sregistry.srv.cesga.es/[sregistry] holding all the singularity images.
Right now its the only such service (see key `sregistry_url` in blueprints) available in the frame of the project.


[[purchase]]
=== Purchase an application

To purchase an application from the *Marketplace* you can either be *DevUser*
or a simple *EndUser*. The process is the following:

* connect to the *Marketplace*, in *Home* (top left Marketplace page) you will find all available apps (*All categories*).
* Click on *Add to Cart* to purchase the app you want.
* Click on *Shopping Cart* and *Checkout* to go on
** ask to fill some form (??)
** provide a *shipping address* if not already defined
** provide a *billing address* if not already defined
** Finalize your order by clicking on *Checkout*

To use the app, you will have to wait that the owner/seller of the app validate
you order. To check the status of your order:

* go to *My Inventory*
* go to *Product Orders*

You shall be to see your products and their status in each product form.
// * check *Requested* and *Recibidas* menus on the top right of *Market Place* web-page

[[data]]
=== Upload Data to *Data Catalog*

* Connect to *Data Catalog*
* Select an organization
* Add a dataset

=== Setting up an HP res-source in *Experiments*

* Go to *Experiments*
* Select *Settings*
* Define a HPV res-source

[source,java]
----
include::{examplesdir}/hpc.txt[]
----

[[running]]
=== Running an {hifimagnet} application in *Experiments*

* Select *Create App Instance*
** define an ID
** select a registered app in the menu

At this point you should have a page with all the options that need to be filled before moving to *Deploy Instance*

image::Portal_HifiMagApp.png[ex: Main {hifimagnet} app]

The fields to fill may be grouped into categories:

* specs for running simulations
* HPC settings
* specs retrieving singularity images
* specs for singularity image

The "EndUser" shall only need to fill the fields related to the 1st and 2nd category.
The fields that are to be filled by *EndUser* are marked in *bold*.

The others fields are designed for more advanced users.


[NOTE]
====

.List of keys specs for running simulations
[options="header,footer"]
|===
| Key                           | Description                                 | Default                                                            | Notes
| *Dataset resource: input_url* | url to retrieve for cfg file and input data | `None`                                                             | URL pointing to an archive of data files (comes from the data Catalog)
| *execfile*                    | executable file                             | `feelpp_hfm_thermoelectric_model_3D_V1T1_N1`                       | any exec `feelpp_hfm...`                  
| *cfgfile*                     | configuration file                          | `/usr/share/doc/hifimagnet/ThermoElectricModel/quarter-turn3D.cfg` | cfg file need to be in the container, or in a mounted dir or in the dataset
|===

.List of keys to be defined for HPC settings
[options="header,footer"]
|===
| Key                        | Description              | Default          | Notes
| *monitor_entrypoint*       |  Monitor entrypoint IP   | "193.144.35.146" | for this release it should be empty
| job_prefix                 | Job name prefix in HPCs  | "mso4sc"         |
| *HPC: primary*               | HPC settings             | "cesga"          | 
| hpc_modules | modules to load depending on the targeted machine | [gcc/6.3.0, openmpi/2.0.2, singularity/2.4.2] | shall depends on HPC and singularity image
| hpc_volumes | volumes to be mounted on the targeted machine |  [/scratch,/mnt,${LUSTRE}/feel:/feel] | depends on HPC and singularity image
| *hpc_partition* | select partition queue | 'thin-shared' | shall depends on batch system and HPC (TODO)
| hpc_reservation | select reservation queue | `` | is optional
| *parallel_tasks* |  number of tasks/processes to run in parallel | 2 |  shall depends on batch system and selected partition
| *max_time* | maximum allowed time for run (minutes and seconds) | '00:30:00' |  shall depends on batch system and selected partition
|===

.List of keys specs for retrieving singularity images
[options="header,footer"]
|===
| Key                        | Description                                    | Default                        | Notes
| sregistry_client           | define default sregistry client                |  `registry`                    | 
| sregistry_client_secrets   | path to file where sregistry secret are stored | `$HOME/.sregistry`             |
| sregistry_storage          | path to container directory                    | `${LUSTRE}/singularity_images` |
| sregistry_url              | URI pointing to the sregistry                  | `sregistry.srv.cesga.es`       |
| sregistry_image            | URI pointing to the sregistry-cli image        | `mso4sc/sregistry`             |
|===

.List of keys specs for singularity image
[options="header,footer"]
|===
| Key                        | Description              | Default          | Notes
| singularity_image_uri      |  URI pointing to the singularity image   | `hifimagnet/hifimagnet:stretch` |
| singularity_image_filename |  Filename of the singularity image       | `hifimagnet-stretch.simg` | 
| singularity_image_cleanup  | force remove of singularity image        | `false` |
|===

====

Once filled, click on *Create Instance*.
This will result in the executions on the selected HPC ressource of the boostrap script included in the app definition.

TIP: Any error will result in a message at the top of the page, bellow the menus.

The next step is to *Deploy Instance*:

* select the *ID*, you defined in the previous step, in the *App instance * menu
* click on *Deploy*

To *Run Instance*, the procedure is similar:

* select the *ID*, you defined in the previous step, in the *App instance * menu
* click on *RUN*

[TIP]
====
these step may take some minutes to be performed. A red button will indicates an error.
Check the message in the frame bellow the status button. To have more details about the actual error
is more tricky; we recommend to:

* make sure you have unchecked the cleanup option
* connect to the HPC resource
* move to the selected `WORKIR`
* check the logs

An other option is to run the app using the *orchestrator CLI*.
see https://github.com/MSO4SC/resources/blob/master/blueprint/feelpp/hifimagnet_test/README.adoc[this file] for details

====

You may cleanup your working by

* UnDeploy your Instance
** select the *ID*, you defined in the previous step, in the *App instance * menu
** click on *UnDeploy*

* Destroy your Instance
** select the *ID*, you defined in the previous step, in the *App instance * menu
** click on *Destroy*

[[post]]
=== Setting up an Remote Desktop resource in *Visualization*

* Go to *Visualization*
* Select *Settings*
* Define a Remote Desktop resource

[source,java]
----
include::{examplesdir}/remotedesktop.txt[]
----

=== Running an Remote Desktop resource in *Visualization*

* Go to *Visualization*
* Click *Desktop Available*
** Select your Visu Settings
** Click on *Create*
** Click either on *Desktop* or *View Only*

it should start a webpage within your browser.
In this page you should be able to:

* start a 'terminal' and check the output of your simulation
* start a post-processing GUI:
** either by loading {paraview}
** or using singularity {ensight} image
* to quit just click on `Menu/logout` (top left)

For more details on using {paraview} or {ensight} please check XXXX

[[hifimagnet_offerings]]
== HifiMagnet Offerings in *Marketplace*

Currently the apps available in the *Marketplace* are given in the table bellow.
They are grouped into 4 categories:

* MagnetTools:
* Preprocessing:
* Simulations:
* Postprocessing:
* Bundles:

.Available {hifimagnet} apps
[options="header,footer"]
|===
| Offering            | Description        | Category    | Notes
| Hifimagnet Offering | Basic demonstrator | Simulations |
|===

== Synopsys of the HifiMagnet Offering

The HifiMagnet offering is created by *DevUser* as described in this <<registerapp, section>>.
Any *EndUser* may purchase the offering following the <<purchase, generic procedure>>. Then,
he or she can run the purchased offering provided that some fields are filled properly as in this <<running, example>>.
Details for setup each offering will be giving in the <<next section,offering_setup>>.

Even if each offering is specific, what is going on under the hood is described here:

* deploy:
* running:
* undeploy:


[[offering setup]]
== To go further

* MagnetTools:
* Preprocessing:
* Simulations:
** direct models
** CRB
* Postprocessing:

== References

* https://github.com/MSO4SC/MSOPortal/blob/master/portal/README.adoc#visualization--pre--post-tool[portal usage]
* https://raw.githubusercontent.com/MSO4SC/resources/master/blueprint/feelpp/hifimagnet_test/upload/blueprint.yaml[blueprints examples]


