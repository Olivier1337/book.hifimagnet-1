= Using the **MSO4SC Portal**
// :toc: macro
include::{partialsdir}/header-macro.adoc[]
include::{partialsdir}/header-uri.adoc[]
include::{partialsdir}/mso4sc-uri.adoc[]


This document will provide basic information:

* to connect to the {uri-msoportal-www}[Portal],
* to register an {hifimagnet} application,
* to purchase an {hifimagnet} application,
* to run an  {hifimagnet} application.

and it defines the role of

* <<devuser, *DevUser*>>
* <<enduser, *EndUser*>>.

An overview of the main portal functionnalities is given in this <<overview,section>>.
This is followed by a brief description of the {hifimagnet} apps available and on the over-whole workflow
of actually running apps within the portal.

The user that have already an account on {uri-msoportal-www}[Portal] may skip the next section
and go directly to the section related to his/her role.


[[connect]]
== Get an account on *MSO4SC Portal*

Connect to {uri-msoportal-www}[MSOPortal]

image::PortalMSO4SC_login.png[login page MSOPortal]

* Click on *login*

You will be forwarded to IDM component to the portal.

image::PortalMSO4SC_idm.png[IDM component of MSOPortal]

* *Sign up* to get an account

image::PortalMSO4SC_signup.png[IDM component of MSOPortal]

TIP: do not check *gravatar* bug as it is buggy right now.

* Create an account there providing a valid email and a password.

Then you have to validate your account by following the instructions send
by the portal.

NOTE: Right now the portal *is not* using https protocol. As a consequence, the credentials `user/password` are
send in clear. So be careful.

[[overview]]
== Overview of the Portal

image::PortalMSO4SC.png[Main page for MSOPortal]

the portal is split into several services:

* *Marketplace*, where you can add and/or purchase applications
* *Data Catalogue*, where you can add and/or retrieve data
* *Experiments*, where the app is setup and the simulation is launched
* *Visualization*, to access a Remote desktop to pre and/or post-processes your simulations

more details on:

* https://github.com/MSO4SC/MSOPortal/blob/master/portal/README.adoc[MSO4SC Front-end & Experiments Tool]
* https://github.com/FIWARE-TMForum/Business-API-Ecosystem/blob/master/doc/user-guide.rst[*Marketplace* User manual]
* https://ckan.org/documentation-and-api/[*Data Catalogue* docs]

[[hifimagnet_offerings]]

== {hifimagnet} Offerings in *Marketplace*

Currently the apps available in the *Marketplace* are given in the table bellow.
They are grouped into 4 categories:

* MagnetTools:
* Preprocessing:
* Simulations:
* Postprocessing:
* Bundles:

.Available {hifimagnet} apps
[options="header,footer"]
|===
| Offering            | Description        | Category    | Notes
| Hifimagnet Offering | Basic demonstrator | Simulations |
|===

For details about settings up these apps please refer to these <<offering setup, docs>>.
For the new user we recommend to read this guide. The impatient may go directly to the <<enduser, *EndUser*>>
 and try to run the basic demonstrator.

== Synopsys of the HifiMagnet Offering

The HifiMagnet offering is created by *DevUser* as described in this <<registerapp, section>>.
Any *EndUser* may purchase the offering following the <<purchase, generic procedure>>. Then,
he or she can run the purchased offering provided that some fields are filled properly as in this <<running, example>>.
Details for setup each offering will be giving in the <<next section,offering_setup>>.

Even if each offering is specific, what is going on under the hood is described here:

* deploy:
* running:
* undeploy:

[NOTE]
====
For app that requires some additional services like:

* {sregistry}: a registry holding singularity images,
* {girder}: a data management system

that requires additional settings (like credentials).

It is important to notify the *EndUser* that he has to get an account on these services.

For {sregistry} see this https://singularityhub.github.io/sregistry/credentials[manual]
for managing the account and this https://singularityhub.github.io/sregistry/client[note]
to setup the {sregistry} client.

As for {girder} ...
====

[[devuser]]
== *DevUser* role

=== Becoming *DevUser*

Once registered in the portal, you  are a *EndUser*.
To be granted *DevUser* rights, just email to Portal Admins (actually Victor or Javi).

[[registerapp]]
===  Register an {hifimagnet} application

To register an application you need to be *DevUSer*
The process is split into several part:

* add the app and create an offer in the {uri-msoportal-market-www}[*Marketplace*]:
** go to *My stock/Catalogue*
** go to *My stock/Product*
** go to *My stock/Offering*

Then you need to perform the following steps in *Experiments*:

* go to *RegisterApp*
** select the name of the *Offering*
** load the application.

[NOTE]
====
An application is an gzipped archive holding a directory which in tunrs contains :

* a `blueprint.yml` TOSCA file that describes the workflow
* a `scripts` subdirectory holding the scripts required to deploy and undeploy the app

In this https://github.com/MSO4SC/resources/tree/master/blueprint/feelpp/hifimagnet_test[git repository]
you will find the actual application corresponding to the {hifimagnet} basic demonstrator.

To actually build the app, use: ```./deploy pkg```
====

[[validorder]]
=== Validate an {hifimagnet} application purchase order

Once the app has been registered in the *Marketplace* (actually it means that an offering has been defined) you will be *owner* of this app. Any *EndUser* may purchase your app.
To check if you have any order:

* go to *My Inventory*
* go to *Product Orders*
* check *Recibibas* menu
* if any new message, you need to:
** click to validate the order
** click again to finalize the order

The *EndUser* may now proceed to perform *Experiments* with you product

[IMPORTANT]
====
Do not forget to notify the user that he/she has to connect once to:

* {uri-sregistry-cesga}[{sregistry} service]
* {uri-msoportal-ckan-www}[*DataCatalogue*]

and eventually to :

* {uri-girder-unistras}[{girder} service]

This steps are mandatory for smooth operation of the app since the user has to be included
into {hifimagnet} user group. Fortunatly this need to be done only once for any {hifimagnet} app.

Unfortunately the management of user has to be carried out manualy by the *DevUser* in charge of the app
and cannot be performed from the portal.
====

[[ckan_dev]]
=== Data Catalogue

As a *DevUser* you can create *Organization* in {uri-msoportal-ckan-www}[*Data Catalogue*]

* ...

You have then to manage user that are allowed to be part of your organization.
They may the following role:

* admin : can view/add dataset, add user and manage role
* editor : can add dataset
* member : can view dataset

NOTE: *EndUser* has to connect at least once to *Data Catalogue* before you can grant them a role in your organization.

[[enduser]]
== *EndUser* role

TIP: when running into some strange portal behavior, first try to `logout/login` from the portal
before reporting an issue.

TIP: make sure that you have access to {uri-sregistry-cesga}[sregistry] holding all the singularity images.
Right now its the only such service (see key `sregistry_url` in blueprints) available in the frame of the project.

[[purchase]]
=== Purchase an application

To purchase an application from the *Marketplace* you can either be *DevUser*
or a simple *EndUser*. The process is the following:

* connect to the {uri-msoportal-ckan-www}[*Marketplace*], in *Home* (top left Marketplace page) you will find all available apps (*All categories*).
* Click on *Add to Cart* to purchase the app you want.
* Click on *Shopping Cart* and *Checkout* to go on
** ask to fill some form (??)
** provide a *shipping address* if not already defined
** provide a *billing address* if not already defined
** Finalize your order by clicking on *Checkout*

To use the app, you will have to wait that the owner/seller of the app validate
you order. To check the status of your order:

* go to *My Inventory*
* go to *Product Orders*

You shall be to see your products and their status in each product form.

To finalize your purchase *DO NOT FORGET* to connect to :

* {uri-sregistry-cesga}[{sregistry}]
* {uri-mosportal-ckan-www}[{*Data Catalogue*}]
* {uri-girder-unistras}[{girder}]

Then notify the ownver/seller that you request to be part of {hifimagnet} user group.
This will allow you to access {himagnet} singularity images and datasets.

NOTE: {girder} is optional.

[[data]]
=== Upload Data to *Data Catalogue*

* Connect to {uri-msoportal-ckan-www}[*Data Catalogue*]
* Select an organization
* Add a dataset if you are assign the role of *editor*

NOTE: you need to ask the owner/seller of {hifimagnet} app to be granted the role of *editor*

=== Setting up an HP res-source in *Experiments*

* Go to {uri-msoportal-experimentstool-www}[*Experiments*]
* Select *Settings*
* Define a HPV res-source

[source,txt]
----
include::{examplesdir}/hpc.txt[]
----

[[running]]
=== Running an {hifimagnet} application in *Experiments*

* Select *Create App Instance*
** define an ID
** select a registered app in the menu

At this point you should have a page with all the options that need to be filled before moving to *Deploy Instance*

image::Portal_HifiMagApp.png[ex: Main {hifimagnet} app]

The fields to fill may be grouped into categories:

* specs for running simulations
* HPC settings
* specs retrieving singularity images
* specs for singularity image

The *EndUser* shall only need to fill the fields related to the 1st and 2nd category.
The fields that are to be filled by *EndUser* are marked in *bold*.

The others fields are designed for more advanced users.


[NOTE]
====

.List of keys specs for running simulations
[options="header,footer"]
|===
| Key                           | Description                                 | Default                                                            | Notes
| *Dataset resource: input_url* | url to retrieve for cfg file and input data | `None`                                                             | URL pointing to an archive of data files (comes from the data Catalog)
| *execfile*                    | executable file                             | `feelpp_hfm_thermoelectric_model_3D_V1T1_N1`                       | any exec `feelpp_hfm...`
| *cfgfile*                     | configuration file                          | `/usr/share/doc/hifimagnet/ThermoElectricModel/quarter-turn3D.cfg` | cfg file need to be in the container, or in a mounted dir or in the dataset
|===

.List of keys to be defined for HPC settings
[options="header,footer"]
|===
| Key                        | Description              | Default          | Notes
| *monitor_entrypoint*       |  Monitor entrypoint IP   | "193.144.35.146" | for this release it should be empty
| job_prefix                 | Job name prefix in HPCs  | "mso4sc"         |
| *HPC: primary*               | HPC settings             | "cesga"          |
| hpc_modules | modules to load depending on the targeted machine | [gcc/6.3.0, openmpi/2.0.2, singularity/2.4.2] | shall depends on HPC and singularity image
| hpc_volumes | volumes to be mounted on the targeted machine |  [/scratch,/mnt,${LUSTRE}/feel:/feel] | depends on HPC and singularity image
| *hpc_partition* | select partition queue | 'thin-shared' | shall depends on batch system and HPC (TODO)
| hpc_reservation | select reservation queue | `` | is optional
| *parallel_tasks* |  number of tasks/processes to run in parallel | 2 |  shall depends on batch system and selected partition
| *max_time* | maximum allowed time for run (minutes and seconds) | '00:30:00' |  shall depends on batch system and selected partition
|===

.List of keys specs for retrieving singularity images
[options="header,footer"]
|===
| Key                        | Description                                    | Default                        | Notes
| sregistry_client           | define default sregistry client                |  `registry`                    |
| sregistry_client_secrets   | path to file where sregistry secret are stored | `$HOME/.sregistry`             |
| sregistry_storage          | path to container directory                    | `${LUSTRE}/singularity_images` |
| sregistry_url              | URI pointing to the sregistry                  | `sregistry.srv.cesga.es`       |
| sregistry_image            | URI pointing to the sregistry-cli image        | `mso4sc/sregistry`             |
|===

.List of keys specs for singularity image
[options="header,footer"]
|===
| Key                        | Description              | Default          | Notes
| singularity_image_uri      |  URI pointing to the singularity image   | `hifimagnet/hifimagnet:stretch` |
| singularity_image_filename |  Filename of the singularity image       | `hifimagnet-stretch.simg` |
| singularity_image_cleanup  | force remove of singularity image        | `false` |
|===

====

Once filled, click on *Create Instance*.
This will result in the executions on the selected HPC resource of the bootstrap script included in the app definition.

TIP: Any error will result in a message at the top of the page, bellow the menus.

The next step is to *Deploy Instance*:

* select the *ID*, you defined in the previous step, in the *App instance * menu
* click on *Deploy*

To *Run Instance*, the procedure is similar:

* select the *ID*, you defined in the previous step, in the *App instance* menu
* click on *RUN*

[TIP]
====
these step may take some minutes to be performed. A red button will indicates an error.
Check the message in the frame bellow the status button. To have more details about the actual error
is more tricky; we recommend to:

* make sure you have unchecked the cleanup option
* connect to the HPC resource
* move to the selected `base_dir/working_prefix<id>`
* check the logs

`base_dir`, `working_prefix` are filled within the portal *Experiments*.
The `<id>` is a random character generated by the deployment.

An other option is to run the app using the *orchestrator CLI*.
see https://github.com/MSO4SC/resources/blob/master/blueprint/feelpp/hifimagnet_test/README.adoc[this file] for details

====

You may cleanup your working by

* UnDeploy your Instance
** select the *ID*, you defined in the previous step, in the *App instance * menu
** click on *UnDeploy*

* Destroy your Instance
** select the *ID*, you defined in the previous step, in the *App instance * menu
** click on *Destroy*

[[post]]
=== Setting up an Remote Desktop resource in *Visualization*

* Go to {uri-msoportal-visu-www}[*Visualization*]
* Select *Settings*
* Define a Remote Desktop resource

[source,java]
----
include::{examplesdir}/remotedesktop.txt[]
----

=== Running an Remote Desktop resource in *Visualization*

* Go to *Visualization*
* Click *Desktop Available*
** Select your Visu Settings
** Click on *Create*
** Click either on *Desktop* or *View Only*

it should start a webpage within your browser.
In this page you should be able to:

* start a 'terminal' and check the output of your simulation
* start a post-processing GUI:
** either by loading {uri-paraview-www}[{paraview}]
** or using singularity {uri-ensight-www}[{ensight}] image
* to quit just click on `Menu/logout` (top left)

For more details on using {paraview} or {ensight} please check XXXX


[[offering setup]]
== To go further

* MagnetTools:
* Preprocessing:
* Simulations:
** direct models
** CRB
* Postprocessing:

== References

* https://github.com/MSO4SC/MSOPortal/blob/master/portal/README.adoc#visualization--pre--post-tool[portal usage]
* https://raw.githubusercontent.com/MSO4SC/resources/master/blueprint/feelpp/hifimagnet_test/upload/blueprint.yaml[blueprints examples]
