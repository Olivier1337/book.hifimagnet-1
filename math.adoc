= HIFIMAGNET
Mayaffre Gabriel <gabriel.mayaffre@free.fr>
v0.1, 2017-04-04
:page-layout!: default
:page-permalink: /math/
:page-root: /
:title: The Modeliing HiFiMagnet Guide
:icons: font
:sectnums:
:sectlinks:
:toc: left
:toclevels: 4
:stem: latexmath
:source-highlighter: highlightjs



== *Notations*

=== Constants and variable

|===
^|Notation ^|Quantity ^|Unit

|latexmath:[\rho]
|material's density
|latexmath:[kg.m^{-3}]

|C~p~
|thermal capacity
|latexmath:[J.K^{-1}]

|r
|radius
|m

|T
|temperature
|K

|k
|thermal conductivity
|latexmath:[W.m^{-1}.K^{-1}]

|U
|electrical potential
|V

|latexmath:[\sigma]
|electrical conductivity
|latexmath:[S.m^{-1}]

|h
|heat transfer coefficient
|latexmath:[W.m^{-2}.K^{-1}]

|===


=== Functions

[horizontal]
latexmath:[\bigtriangledown f]:: gradient of latexmath:[f]
latexmath:[\bigtriangledown.\overrightarrow{f}]:: divergence of latexmath:[\overrightarrow{f}]
latexmath:[L_{2}(\Omega)]:: latexmath:[\{f  \mid \int f^{2} < \infty\}]  Lagrangian
latexmath:[H_{1}(\Omega)]:: latexmath:[\{f \in L_{2}(\Omega) \mid \bigtriangledown f \in [L_{2}(\Omega)\]^{d}\}]  Hilbert space

== *Modelisation*

The study of a magnet is a multi-physic problem. It combine electromagnetism, thermic and mechanics.
We divide the modelisation into 4 parts:

. *Thermo-electric* +
The current flow inside the magnet (copper) involves a warming of the material, due to Joule effect.
The temperature in the different sections of the magnet are calculated thanks to the heat equation (more details below).
. *Elasticity* +
The temperature's elevation involves a dilatation of the material. It implies some constraints due to the nature of the material.
. *Hydraulics* +
Due to the strong current flow inside the magnet, the temperature will rise dangerously.
We need to cool down the magnet, with fluid which will circulate around the material.
This involves the Colburn correlation with the properties of the fluid.
. *Electromagnetism* +
The purpose of a magnet is to create a magnetic field, consequently, we will use the Maxwell's equations.

=== Model


First, you need to create the 3D model on `Salome` and to make the mesh.
When the mesh is created, with specific names for the volumes and surfaces, export your creation in `.med` (example : `example_mesh.med`).
You also need to partition the mesh to allow the number of processors you want to do the calculations in parallel, running this command :
----
~trophime/feelpp_build/new_Json/applications/mesh/feelpp_mesh_partitioner --ifile "name_of_your_file.med" --part "number_of_processors_you_want_to_use" --nochdir
----

example :
----
~trophime/feelpp_build/new_Json/applications/mesh/feelpp_mesh_partitioner --ifile example_mesh.med --part 4 --nochdir
----

This will create a new file, call `"name_of_your_file"_p"number_of_processor_you_want".json` (example_mesh_p4.json) that you will use in your configure file.

=== Thermo-electric

You can use ether the linear or the nonlinear model for your calculation, but for our example, we use the linear model, so we select the `thermoelectric-linear` (respectively `thermoelectric-nonlinear`) model in the Json file (details in the <<code.json>>).

When all the files (detailed below) are created, you can run your calculation with this command :

.to execute your calculation
----
mpirun -np "number_of_processor_you_have_chosen_in_the_partition" ~trophime/feelpp_build/new_Json/research/hifimagnet/applications/ThermoElectricModel/feelpp_hfm_thermoelectric_model_3D_V1T1_N1 --config-file "name_of_your_file.cfg"
----

==== Matérial

.Correspondence between parameters and symbols in JSon files
|===
^|Parameter ^|Symbol

|latexmath:[\alpha]
|alpha

|latexmath:[\sigma_{0}] / latexmath:[\sigma]
|sigma0 / sigma

|k~0~ / k
|k0 / k

|T~0~
|T0

|===

There is a dedicated section in the Json file, named `Materials`, to configure the magnet properties.
The structure of a json file is as follows (conditions are details in <<Condition>>) :

[[code.json]]
[source,JavaScript]
.Example.json
....
{
    "Name": "ThermoElectric",
    "ShortName":"TE",
    "Model":"thermoelectric-linear",
    "Materials":
    {
	   "Name_of_the_first_volume":
	    {
	     "name":"material_of_this_volume",
	      "alpha":"_",
	      "T0":"_",
	      "sigma0":"_",
	      "k0":"_",
	      "sigma":"sigma0/(1+alpha*(T-T0)):sigma0:alpha:T:T0",
	      "k":"k0*T/((1+alpha*(T-T0))*T0):k0:T:alpha:T0"
	    },
	  "other_volume":
	   {
	    ...
	   }
  },
    "BoundaryConditions":
    {
	   "first_condition(like potential or temperature)":
	    {
	     "type_of_condition":
	      {
		      "Surface_concerned_by_the_condition":
		        {
		          "expr1":"_",
		          "expr2":"_"
		        },
		      "Surface_concerned_by_the_condition":
		        {
		          "expr1":"_",
		          "expr2":"_"
		        }
	      }
	   },
	    "other_condition":
	     {
	      ...
	     }
    },
    "PostProcess":
      {
	     "Fields":["temperature","potential","current"]
      }
}
....
WARNING: The name of the volumes and surfaces must be the same as defined in `Salome`.
Be carefull of the value of the characteristic of the material, the units being in mm (like ine <<test.json>>).

It is also necessary to create a file to configure the calculation, call `.cfg` file (example <<example_file.cfg>>).
It will configure which file you will use in your calculations and which type of calculation you do (here we use the Krylov method with the conditions define in the subparts `electro` and `thermal`).
There are few differences between the linear and the nonlinear calculation.

.Example_linear.cfg
....
dim=3
geofile="name_of_the_file_created_by_the_partition.json" (or .msh)
geofile-path=$cfgdir


conductor_volume="name_of_your_volume"

[thermoelectric]
model_json=$cfgdir/"name_of_your_file.json"
weakdir=false

[electro]
pc-type=gamg
#ksp-monitor=true
ksp-rtol="relative_convergence_tolerance"
ksp-atol="absolute_convergence_tolerance"
ksp-maxit="maximum_number_of_iterations"
ksp-use-initial-guess-nonzero=1

[thermal]
pc-type=gamg
#ksp-monitor=true
ksp-rtol="relative_convergence_tolerance"
ksp-atol="absolute_convergence_tolerance"
ksp-use-initial-guess-nonzero=1
....

For the nonlinear model, just add this lines in the section `thermoelectric` :

.nonlinear
....
eps_potential=1.e-4
eps_temperature=1.e-4
resolution=picard
itmax_picard=10
update_intensity=true
marker_intensity="the_surface"
target_intensity="the_intensity" (be careful of the sign)
eps_intensity=1.e-2
verbosity=2
....

==== Condition

There are three type of conditions :

1 *Dirichlet*

[source,JavaScript]
.Dirichlet Condition
....
"Dirichlet": //values of the solution known at the limits of the domain
  {
    "Surface":
      {
        "expr1":"Value_of_the_solution"
        "expr2":"Volume_concerned"
      },
    "other_surface":
      {
        "expr1":"Value_of_the_solution"
        "expr2":"Volume_concerned"
      }
  }
....
2 *Neumann*

[source,JavaScript]
.Neumann Condition
....
"Neumann":  // value of the derivative of the solution knowns at the limit of the domain
  {
    "Surface":
      {
        "expr":"Value_of_derivatives_of_the_solution"
      },
    "other_surface":
      {
        "expr":"Value_of_derivatives_of_the_solution"
      }
  }
....
3 *Robin*

[source,JavaScript]
.Robin Condition
....
"Robin":   // linear relation between the value and the derivative at the limits of the domain
  {
    "Surface":
      {
        "expr1":"Value_of_derivatives_of_the_solution"
        "expr2":"Value_of_the_solution"
      },
    "other_surface":
      {
        "expr1":"Value_of_derivatives_of_the_solution"
        "expr2":"Value_of_the_solution"
      }
  }
....

WARNING: Your have to set a condition for each surfaces you have defined.
For those where there is no conditions, set an homogeneous Neumann condition (`"expr":"0"`)

==== Example

In our example, we approximate the magnet with an axisymmetric copper torus.Thus we can consider only a quarter of this torus for our study.
The torus is modeled thanks to the file geo, which also name the volume (`omega`) and each surface.

.Model of the quarter of torus on `Gmsh`
image::quarter-turn3D.png[quarter of a torus,300,200,align="center"]

===== Equations

First of all, we start with the standart heat equation : +
latexmath:[\rho C_{p}\frac{\partial T}{\partial t} - \bigtriangledown.(k \bigtriangledown T)=\sigma(\frac{U}{2\pi r})^{2}]

Coefficients latexmath:[\sigma] and k are in fact, temperature-dependent, shown in this equations :

* latexmath:[\sigma=\frac{\sigma_ {0}}{1 + \alpha(T-T_{ref})}]

* latexmath:[k=k_{0}\frac{T}{(1+\alpha(T-T_{ref}))T_{ref}}]

But, for the next, we consider that latexmath:[\alpha=0] and T=T~ref~.
Thereby, we are in a linear problem that we can solve with the `thermoelectric-linear` model in the Json file.

In our case, we consider that T only depends on the radius, so latexmath:[\frac{\partial T}{\partial t}=0].
We can now consider this equation : +
latexmath:[T=A\log(r)-\frac{\sigma}{2k}(\frac{U}{2\pi})^{2}\log^{2}(r)+B]

The constants A and B are determined by the boundary conditions (Dirichlet and Robin).

Finally, we have this equation : +
latexmath:[T=-a \log(\frac{r}{r_{0}})^{2} + T_{max}]

- latexmath:[T_{max}=\frac{2ak}{h_{1}r_{1}+h_{2}r_{2}}\log(\frac{r_{2}}{r_{1}})+\frac{h_{1}r_{1}T_{w1}+h_{2}r_{2}T_{w2}}{h_{1}r_{1}+h_{2}r_{2}}
 + a\frac{h_{1}r_{1}log(\frac{r_{1}}{r_{0}})^{2}+h_{2}r_{2}log(\frac{r_{2}}{r_{0}})^{2}}{h_{1}r_{1}+h_{2}r_{2}}]

- latexmath:[r_{0}=e^{\frac{\frac{T_{w2}-T_{w1}}{b}+\frac{ac}{b}}{2a}}]

- latexmath:[a=\frac{\sigma_{0}}{2k}(\frac{U}{2\pi})^{2}]

- latexmath:[b=k(\frac{1}{h_{1}r_{1}}+\frac{1}{h_{2}r_{2}})+\log(\frac{r_{2}}{r_{1}})]

- latexmath:[c=\log(\frac{r_{2}}{r_{1}})\log(r_{1}r_{2}) + 2k (\frac{\log(r_{1})}{h_{1}r_{1}}+\frac{\log(r_{2})}{h_{2}r_{2}})]

r~0~ is the radius for which the temperature is at its maximum.

===== Parameters

In our case, we choose the parameters like this :

.Fixed and variable parameters
[%autowidth.spread,options="header"]
|===
^|Name ^|Description ^|Range ^|Nominal Value ^|Unit

|latexmath:[\sigma_{0}]
|electrical conductivity at T~0~
^|latexmath:[[52.10^{6}; 58.10^{6}]]
^|latexmath:[58.10^{6}]
|latexmath:[S.m^{-1}]

|k
|thermal conductivity
^|[360;380]
^|380
|latexmath:[W.m^{-1}.K^{-1}]

|r~1~
|internal radius
^|latexmath:[1.10^{-3}]
^|latexmath:[1.10^{-3}]
|m

|r~2~
|internal radius
^|latexmath:[2.10^{-3}]
^|latexmath:[2.10^{-3}]
|m

|T~w1~
|water cooling temperature on radius r~1~
^|[293;310]
^|293
|K

|T~w2~
|water cooling temperature on radius r~2~
^|[293;310]
^|293
|K

|h~2~
|heat transfer coefficient
^|[70000;90000]
^|80000
|latexmath:[W.m^{-2}.K^{-1}]

|h~1~
|heat transfer coefficient
2+^|latexmath:[h_{1}=h_{2}\frac{r_{2}}{r_{1}}]
|latexmath:[W.m^{-2}.K^{-1}]

|V~0~
|electrical potential
^|-
^|0.3
|V

|===

===== Conditions

We set 2 conditions :

* Dirichlet for the potential : V~in~=0 V  and  latexmath:[V_{out}=V_{0}\frac{1}{4}=0.075  V] _because we consider only one quarter of the torus_.

* Robin for the temperature :

** On r~int~ : latexmath:[h_{1}=80000\frac{r_{2}}{r_{1}}=160000 W.m^{-2}.K^{-1}]  and  T~w1~=293 K

** On r~ext~ : h~2~=80000 latexmath:[W.m^{-2}.K^{-1}]  and  T~w2~= 293 K


===== Results

.Temperature's repartition on paraview
image::Temperature_paraview.png[Temperature_paraview,500,300,float="left"]

.Theorical and numerical temperature
image::TemperatureTH.png[TemperatureTH,450,300,float="right"]



We can vary the degree of the finite element from 1 (linear) to 2 (quadratic). +
To prove the convergence towards the theory, we plot the difference between L~2~/H~1~ and the theoretical formulas for T and V.
The scale is logarithmic, to see directly the slope and note that it is directly linked to the degree of the finite element used.

latexmath:[T=-a \log(\frac{r}{r_{0}})^{2} + T_{max}]

latexmath:[V=\frac{0.3*atan2(x,y)}{2\pi}]

* For L2, we have directly the output on the table obtained whether for T or for V
* For H1, we need to do a quadratical mean between the H1 and L2 of the table (latexmath:[\sqrt{H1^{2}+L2^{2}}]) for T and V

.Electrical potential convergence study for L2
image::L2(V).png[L2(V),475,400,float="left"]
.Electrical potential convergence study for H1
image::H1(V).png[H1(V),475,400,float="right"]
.Temperature convergence study for L2
image::L2(T).png[L2(T),475,400,float="left"]
.Temperature convergence study for H1
image::H1(T).png[H1(T),475,400,float="right"]

===== Code

For the modelisation of the quarter of torus, we create the geometry and the mesh on `Salome` and export the file in `.geo`

.quarter-turn3D.geo
----
// Define Main params
Unit = 1.e-3;
lc = 1*Unit;
lc_ext = 3*lc;
lc_inf = 1*lc;

h=0.2;
r1=1;
r2=2;
L=2*r2;



Mesh.ElementOrder = 1;
Point(1) = {0, 0, -L, h};
Point(2) = {r1, 0, -L, h};
Point(3) = {r2, 0, -L, h};
Point(4) = {0, r1, -L, h};
Point(5) = {0, r2, -L, h};
Circle(1) = {2, 1, 4};
Circle(2) = {3, 1, 5};
Line(3) = {4, 5};
Line(4) = {2, 3};
Line Loop(5) = {3, -2, -4, 1};
Plane Surface(1) = {5};

out[] = Extrude {0,0,L} {Surface{1};};

Physical Volume("omega") = {out[1]};
Physical Surface("top") = {out[0]};
Physical Surface("bottom") = {1};
Physical Surface("Rint") = {out[5]};
Physical Surface("Rext") = {out[3]};
Physical Surface("in") = {out[2]};
Physical Surface("out") = {out[4]};
----

Next step is to create a file.json which define the model we will use, the material and sets the conditions.

[[test.json]]
[source,JavaScript]
.quarter-turn3D.json
....
{
    "Name": "ThermoElectric",
    "ShortName":"TE",
    "Model":"thermoelectric-linear",

    "Materials":
    {
        "omega":
        {
            "name":"copper",
            "alpha":"3.35e-3",
            "T0":"293",
            "sigma0":"58e+3",
            "k0":"0.38",
            "sigma":"sigma0/(1+alpha*(T-T0)):sigma0:alpha:T:T0",
            "k":"k0*T/((1+alpha*(T-T0))*T0):k0:T:alpha:T0"
        }
    },
    "BoundaryConditions":
    {
        "potential":
        {
            "Dirichlet":
            {
                "in":
                {
                    "expr1":"0",
		    "expr2":"omega"
                },
                "out":
                {
                    "expr1":"0.3/4.", // since we consider only 1/4th of a torus
		    "expr2":"omega"
                }
        },
        "temperature":
        {
            "Robin":
            {
                "Rext":
                {
                    "expr1":"0.08",
                    "expr2":"293"
                },
                "Rint":
                {
                    "expr1":"0.08*(2./1.)",
                    "expr2":"293"
                }
            }
        }
    },
    "PostProcess":
    {
        "Fields":["temperature","potential","current"]
    }
}
....

Lastly, we create a file.cfg to configure what we will calculate.

[[example_file.cfg]]
.thermoelectric_3D_V1T1_N1_cvg.cfg (for the T1V1 model)
....
dim=3
geofile=quarter-turn3D.geo
geofile-path=$cfgdir
gmsh.hsize=0.2

conductor_volume=omega

[convergence]
max_iter=5

[functions]
#V_exact
f=0.3*atan2(x,y)/(2*pi):x:y:z
#T_exact
g=600.312-58.e+3/(2*0.38)*(0.3/(2*pi))^2*log(sqrt(x*x+y*y)/sqrt(1*2))^2:x:y:z

[thermoelectric]
model_json=$cfgdir/quarter-turn3D.json
weakdir=false

[electro]
pc-type=gamg
#ksp-monitor=true
ksp-rtol=1e-7
ksp-atol=1e-5
ksp-maxit=2000
ksp-use-initial-guess-nonzero=1

[thermal]
pc-type=gamg
#ksp-monitor=true
ksp-rtol=1e-8
ksp-atol=1e-6
ksp-use-initial-guess-nonzero=1
....

Finally, to execute our program, run this command :

.to study the convergence
....
mpirun -np 4 ~trophime/feelpp_build/new_Json/research/hifimagnet/testsuite/ThermoElectricModel/feelpp_test_convergence_3D_V1T1_N1  --config-file thermoelectric_3D_V1T1_N1_cvg.cfg
....

It will create a table with all the informations you need. For our example, we showed the convergence using L2 and H1 (in section <<Results>>).

.to apply for a real case (theory not known)
....
mpirun -np 4 ~trophime/feelpp_build/new_Json/research/hifimagnet/applications/ThermoElectricModel/feelpp_hfm_thermoelectric_model_3D_V1T1_N1 --config-file thermoelectric_3D_V1T1_N1_cvg.cfg
....

This command will create files in `~/feel/hifimagnet/ThermoElectricModel/...` . You can see the results with Paraview or Ensight opening `Thermics.case` or `Electrics.case` in the software of your choice.


=== Elasticity

==== Matérial

==== Condition

==== Example

=== Hydraulic

==== Matérial

==== Condition

==== Example

=== Electromagnetism (Maxwell)

==== Matérial

==== Condition

==== Example


== *ANNEXE*
=== Validity
